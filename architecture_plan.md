# Архитектурный план улучшений FastQCLI

## Обзор текущей архитектуры

### Существующие компоненты:
1. **fastqcli.py** - основной CLI модуль с функциями анализа
2. **streamlit_simple.py** - веб-интерфейс Streamlit (упрощенная версия)
3. **core/analyzer.py** - модуль анализа FASTQ файлов
4. **core/reporter.py** - генератор отчетов

### Текущий функционал:
- Загрузка и анализ FASTQ файлов через веб-интерфейс
- Генерация HTML отчетов через Sequali
- Временное хранение файлов в tempfile
- Базовая история анализов в session_state

## Требуемые улучшения

### 1. Система хранения загруженных файлов
**Цель:** Сохранять загруженные файлы для повторного анализа

**Реализация:**
- Создать директорию `uploaded_files/` для постоянного хранения
- Добавить в session_state полную историю с метаданными файлов
- Реализовать систему управления дисковым пространством

### 2. Реестр HTML отчетов
**Цель:** Хранить и управлять всеми сгенерированными отчетами

**Реализация:**
- Создать директорию `reports/` для постоянного хранения отчетов
- Добавить базу данных отчетов в session_state
- Связать отчеты с исходными файлами

### 3. Интерфейс с вкладками
**Цель:** Организовать функционал в удобные вкладки

**Вкладки:**
1. **Новый анализ** - текущий функционал загрузки и анализа
2. **История файлов** - список загруженных файлов с возможностью повторного анализа
3. **Реестр отчетов** - список всех отчетов с возможностью просмотра

### 4. Полноэкранный просмотр отчетов
**Цель:** Улучшить UX при просмотре отчетов

**Реализация:**
- Использовать st.modal() или отдельную страницу для полноэкранного просмотра
- Добавить кнопку "Просмотреть отчет" после анализа
- Реализовать iframe на весь экран

## Структура данных

### Session State структура:
```python
st.session_state = {
    'sequali_installed': bool,
    'uploaded_files': {
        'file_id': {
            'filename': str,
            'path': str,
            'size_mb': float,
            'upload_time': datetime,
            'hash': str,
            'analysis_count': int
        }
    },
    'reports': {
        'report_id': {
            'file_id': str,
            'filename': str,
            'report_path': str,
            'creation_time': datetime,
            'metrics': dict,
            'status': str
        }
    },
    'current_tab': str,
    'fullscreen_report': str  # путь к отчету для полноэкранного просмотра
}
```

## Новая структура директорий:
```
FastQCLI/
├── fastqcli.py
├── streamlit_simple.py  # обновленный с новым функционалом
├── core/
│   ├── analyzer.py
│   └── reporter.py
├── data/                # новая директория для хранения данных
│   ├── uploaded_files/  # загруженные файлы
│   ├── reports/         # HTML отчеты
│   └── metadata.json    # метаданные файлов и отчетов
```

## План реализации

### Этап 1: Подготовка инфраструктуры
1. Создать директории для хранения данных
2. Добавить функции для управления файлами
3. Реализовать сохранение/загрузку метаданных

### Этап 2: Обновление интерфейса
1. Добавить систему вкладок в Streamlit
2. Реализовать вкладку "История файлов"
3. Реализовать вкладку "Реестр отчетов"

### Этап 3: Функционал повторного анализа
1. Добавить кнопки повторного анализа в истории
2. Реализовать логику повторного анализа
3. Связать новые отчеты с файлами

### Этап 4: Полноэкранный просмотр
1. Реализовать модальное окно или отдельную страницу
2. Добавить кнопку "Просмотреть отчет"
3. Настроить iframe для полноэкранного отображения

## Преимущества новой архитектуры

1. **Эффективность**: Не нужно загружать файлы повторно
2. **История**: Полная история анализов и отчетов
3. **Удобство**: Вкладки для организации функционала
4. **UX**: Полноэкранный просмотр отчетов
5. **Масштабируемость**: Легко добавлять новые функции

## Технические детали

### Хранение файлов:
- Использовать хеширование для избежания дубликатов
- Автоматическая очистка старых файлов (опционально)
- Сжатие файлов для экономии места

### Управление отчетами:
- Уникальные ID для каждого отчета
- Связь с исходным файлом через file_id
- Возможность экспорта/импорта отчетов

### Производительность:
- Ленивая загрузка отчетов
- Кеширование метаданных
- Асинхронная обработка где возможно